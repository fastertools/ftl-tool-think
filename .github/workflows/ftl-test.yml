name: FTL Test

on:
  push:
    branches: [ fix-smoke-tests ]

env:
  CARGO_TERM_COLOR: always

jobs:
  ftl-test:
    name: FTL Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: fastertools/actions/actions/setup-ftl@739b32e2d7e137c17102284326ec6fc3e16d78f5
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1
      
      - name: Build WASM
        run: ftl build

      - uses: fastertools/actions/actions/start-ftl-server@739b32e2d7e137c17102284326ec6fc3e16d78f5
      
      - name: Test MCP endpoint
        run: |
          HEALTH_URL="http://localhost:8080/mcp"
          mcp_request='{"jsonrpc":"2.0","method":"ping","id":1}'
          
          mcp_response=$(curl -w "HTTP_STATUS:%{http_code}" -s --connect-timeout 5 --max-time 10 \
               -H "Content-Type: application/json" \
               -X POST \
               -d "$mcp_request" \
               "$HEALTH_URL" 2>&1)
          
          http_status=$(echo "$mcp_response" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          
          if [[ "$http_status" == "200" ]]; then
            echo "✅ MCP endpoint responding with HTTP 200"
          else
            echo "❌ MCP endpoint failed with status: $http_status"
            echo "Response: $mcp_response"
            exit 1
          fi
      