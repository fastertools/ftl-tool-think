name: FTL Test

on:
  push:
    branches: [ fix-smoke-tests ]

env:
  CARGO_TERM_COLOR: always

jobs:
  ftl-test:
    name: FTL Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup FTL CLI with Dependencies
        uses: fastertools/actions/actions/setup-ftl-js@60fd1ed00e57ccd07ace8d2956e1078211a58347
        with:
          version: 'latest'
          use-cache: true

      # - name: Start FTL Server
      #   uses: fastertools/actions/ftl-server-up@9ba64633b5e43b68d3973e020ff1a970d4ee15a6
      #   with:
      #     port: 3000
      #     timeout: 30
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1
      
      - name: Build WASM
        run: ftl build

      # - uses: fastertools/actions/actions/ftl-eng-deploy@21403b8e36d45ab02cbe5fe8c0fc9951f56cb9bc
      #   env:
      #     FTL_M2M_APP_CLIENT_ID: ${{ secrets.FTL_M2M_APP_CLIENT_ID }}
      #     FTL_M2M_APP_CLIENT_SECRET: ${{ secrets.FTL_M2M_APP_CLIENT_SECRET }}
      
      - name: Test MCP endpoint
        run: |
          HEALTH_URL="http://localhost:3000/mcp"
          mcp_request='{"jsonrpc":"2.0","method":"ping","id":1}'
          
          mcp_response=$(curl -w "HTTP_STATUS:%{http_code}" -s --connect-timeout 5 --max-time 10 \
               -H "Content-Type: application/json" \
               -X POST \
               -d "$mcp_request" \
               "$HEALTH_URL" 2>&1)
          
          http_status=$(echo "$mcp_response" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          
          if [[ "$http_status" == "200" ]]; then
            echo "✅ MCP endpoint responding with HTTP 200"
          else
            echo "❌ MCP endpoint failed with status: $http_status"
            echo "Response: $mcp_response"
            exit 1
          fi
      